# LogoutUserCommandHandlerTest

Тесты для обработчика команды выхода из системы (`LogoutUserCommandHandler`).

## Назначение

Проверяет корректность выхода пользователя из системы, включая различные сценарии аутентификации.

## Тестируемые сценарии

### ✅ Успешные сценарии

#### `Handle_ValidLogout_ReturnsSuccessResult`
**Цель:** Проверить успешный выход аутентифицированного пользователя.

**Входные данные:**
- Команда без параметров (использует текущего пользователя)

**Ожидаемый результат:**
- `Result.IsSuccess = true`
- `Result.Message = "Выход выполнен успешно"`

**Логика теста:**
1. Создается команда выхода
2. Отправляется команда через MediatR
3. Проверяется успешность результата и корректность сообщения

#### `Handle_LogoutWhenNotAuthenticated_ReturnsSuccessResult`
**Цель:** Проверить выход неаутентифицированного пользователя.

**Входные данные:**
- Команда без параметров (пользователь не аутентифицирован)

**Ожидаемый результат:**
- `Result.IsSuccess = true`
- Операция должна быть успешной даже если пользователь не был аутентифицирован

**Логика теста:**
1. Создается команда выхода
2. Отправляется команда через MediatR
3. Проверяется успешность результата

## Используемые моки

### SignInManagerMock
- Симулирует метод `SignOutAsync()`
- Всегда возвращает успешный результат
- Не выбрасывает исключения

### SecurityServiceMock
- Возвращает тестового пользователя с ролью `Organizer`
- Используется для получения текущего пользователя

## Зависимости

- **MediatR** - для отправки команд
- **Steps.Application.Interfaces.Base** - для интерфейсов сервисов

## Пример использования

```csharp
[Fact]
public async Task Handle_ValidLogout_ReturnsSuccessResult()
{
    // Arrange
    var mediator = _scope.ServiceProvider.GetRequiredService<IMediator>();
    var command = new LogoutUserCommand();

    // Act
    var result = await mediator.Send(command);

    // Assert
    Assert.True(result.IsSuccess);
    Assert.Equal("Выход выполнен успешно", result.Message);
}
```

## Бизнес-правила

1. **Безопасность** - выход должен быть возможен в любое время
2. **Идемпотентность** - повторный выход не должен вызывать ошибки
3. **Успешность операции** - выход должен быть успешным даже если пользователь не был аутентифицирован
4. **Очистка сессии** - должны очищаться данные аутентификации

## Важные моменты

1. **Простота операции** - выход не требует сложной логики
2. **Безопасность** - операция должна быть безопасной в любом состоянии
3. **Изоляция тестов** - каждый тест независим от других
4. **Мокирование зависимостей** - внешние зависимости заменены на моки

## Связанные тесты

- `LoginRequestCommandHandlerTest` - тесты входа в систему
- `CurrentUserQueryHandlerTest` - тесты получения текущего пользователя
- `RegisterUserCommandHandlerTest` - тесты регистрации

## Особенности тестирования

1. **Простота сценариев** - тестируется только успешные сценарии
2. **Проверка сообщений** - убеждаемся, что возвращается правильное сообщение
3. **Безопасность** - тестируется, что выход безопасен в любом состоянии
4. **Идемпотентность** - проверяется, что повторный выход не вызывает проблем

## Логика работы

### Успешный выход
1. Получение текущего пользователя (если аутентифицирован)
2. Вызов `SignInManager.SignOutAsync()`
3. Возврат успешного результата с сообщением

### Выход неаутентифицированного пользователя
1. Попытка получения текущего пользователя
2. Вызов `SignInManager.SignOutAsync()` (даже если пользователь не найден)
3. Возврат успешного результата

## Сообщения об ошибках

В данном обработчике не предусмотрены сценарии с ошибками, так как выход из системы должен быть безопасной операцией, которая всегда завершается успешно.

## Рекомендации по использованию

1. **Всегда вызывать** - выход должен вызываться при завершении сессии
2. **Обработка результата** - проверять успешность операции
3. **Перенаправление** - после выхода перенаправлять на страницу входа
4. **Очистка UI** - скрывать элементы, доступные только аутентифицированным пользователям 