@using Steps.Client.Features.EntityFeature.ContestsFeature.Services
@using Steps.Domain.Base
@using Steps.Domain.Definitions
@using Steps.Shared.Contracts.Contests.ViewModels

<RadzenCard>
    <RadzenScheduler TItem="ContestViewModel" Data="@Contests" LoadData="@Load" 
                     TodayText="Сегодня" NextText="Далее" PrevText="Назад"
                     
                     StartProperty="@nameof(ContestViewModel.StartDate)" 
                     EndProperty="@nameof(ContestViewModel.EndDate)" TextProperty="@nameof(ContestViewModel.Name)"
                     AppointmentSelect="@(e => ShowCardDialog(e.Data))"
                     SlotSelect="GetSlotSelectHandle()">
        <RadzenMonthView Text="Месяц" />
        <RadzenWeekView Text="Неделя"/>
        <RadzenDayView Text="День"/>
    </RadzenScheduler>
</RadzenCard>

@code{
    private Role? UserRole => User?.Role;
    
    [Inject] private ContestDialogManager ContestDialogManager { get; set; } = null!;
    [Inject] private ContestManager ContestManager { get; set; } = null!;
    
    private IEnumerable<ContestViewModel>? Contests { get; set; }
    [CascadingParameter] public IUser? User { get; set; }

    private DateTime _currentStartDate;
    private DateTime _currentEndDate;
    

    private async Task Load(SchedulerLoadDataEventArgs arg)
    {
        _currentStartDate = arg.Start;
        _currentEndDate = arg.End;
        await RefreshContests();
    }
    
    private EventCallback<SchedulerSlotSelectEventArgs> GetSlotSelectHandle()
    {
        if (UserRole is Role.Organizer)
        {
            return EventCallback.Factory.Create<SchedulerSlotSelectEventArgs>(this, async e =>
            {
                var result = await ContestDialogManager.ShowCreateDialog();
                if (result)
                {
                    await RefreshContests();
                }
            });
        }
        else
        {
            return EventCallback.Factory.Create<SchedulerSlotSelectEventArgs>(this, e => NoAccessMessage());
        }
    }
    
    private async Task RefreshContests()
    {
        var result = await ContestManager.GetByTimeInterval(_currentStartDate, _currentEndDate);
        if (result.IsSuccess)
        {
            Contests = result.Value;
            StateHasChanged();
        }
    }

    private void NoAccessMessage()
    {
        Console.WriteLine("У вас нет прав для создания мероприятий.");
    }

    private async Task ShowCardDialog(ContestViewModel model)
    {
        await ContestDialogManager.ShowCardDialog(model);
    }
}