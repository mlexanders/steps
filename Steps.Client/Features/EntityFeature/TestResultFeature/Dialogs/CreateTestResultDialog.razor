@using Radzen
@using Steps.Client.Features.EntityFeature.AthleteFeature.Services
@using Steps.Client.Features.EntityFeature.TestResultFeature.Services
@using Steps.Shared.Contracts.TestResults.ViewModels

@inherits Steps.Client.Features.Common.BaseModal
@inject TestResultsManager TestResultsManager
@inject AthleteManager AthleteManager

<RadzenTemplateForm TItem="CreateTestResultViewModel" Model="_createTestResultViewModel">
    <ChildContent>
        <RadzenFieldset Text="Оценки за элементы">
            <RadzenNumeric @bind-Value="_createTestResultViewModel.Scores[0]" Min="0" Max="10" Step="1"
                           Style="width: 100%" Placeholder="@_elementNames[0]"/>
            <RadzenNumeric @bind-Value="_createTestResultViewModel.Scores[1]" Min="0" Max="10" Step="1"
                           Style="width: 100%" Placeholder="@_elementNames[1]"/>
            <RadzenNumeric @bind-Value="_createTestResultViewModel.Scores[2]" Min="0" Max="10" Step="1"
                           Style="width: 100%" Placeholder="@_elementNames[2]"/>
            <RadzenNumeric @bind-Value="_createTestResultViewModel.Scores[3]" Min="0" Max="10" Step="1"
                           Style="width: 100%" Placeholder="@_elementNames[3]"/>
            <RadzenNumeric @bind-Value="_createTestResultViewModel.Scores[4]" Min="0" Max="10" Step="1"
                           Style="width: 100%" Placeholder="@_elementNames[4]"/>
        </RadzenFieldset>

        <RadzenButton Text="Сохранить" Icon="save" Click="@Create" Style="margin-top: 10px"/>
    </ChildContent>
</RadzenTemplateForm>

@code {
    private readonly CreateTestResultViewModel _createTestResultViewModel = new()
    {
        Scores = new List<int> { 0, 0, 0, 0, 0 }
    };

    private List<string> _elementNames = new();

    [Parameter] public Guid ContestId { get; set; }
    [Parameter] public Guid AthleteId { get; set; }

    protected override async Task OnParametersSetAsync()
    {
        _createTestResultViewModel.ContestId = ContestId;
        _createTestResultViewModel.AthleteId = AthleteId;

        await LoadAthleteElements();
    }

    private async Task LoadAthleteElements()
    {
        var athlete = await AthleteManager.Read(AthleteId);
        if (athlete?.Value.AthleteElements == null) return;

        _elementNames = new List<string>
        {
            athlete.Value.AthleteElements.Element1,
            athlete.Value.AthleteElements.Element2,
            athlete.Value.AthleteElements.Element3,
            athlete.Value.AthleteElements.Element4,
            athlete.Value.AthleteElements.Element5
        };

        StateHasChanged();
    }

    private async Task Create()
    {
        var result = await TestResultsManager.Create(new()
        {
            ContestId = _createTestResultViewModel.ContestId,
            AthleteId = _createTestResultViewModel.AthleteId,
            Scores = _createTestResultViewModel.Scores
        });

        ShowResultMessage(result);

        if (result.IsSuccess) Close(true);
    }
}
